---
title: "LINCs MEPs PC3 SS2 Pilot Control Plate Analysis"
author: "Mark Dane"
date: "`r Sys.Date()`"
output: pdf_document
---

##Summary
This report covers three wells in the control plate for PC3 cells using the LINCs MEP cell cycle staining set. Observations are:

  The EdU signal is much lower than prior experiments with less than 8% of the cells proliferating (compared to typically 40-60%).

  The EdU signal rises sharply as the spot cell count decreases. 

  The raw H3K9me3 and fibrillarin signals show weak and opposing correlations to spot cell count.

This report introduces Density as a derived measurement.


##Introduction
This dataset contains cell-level data for LINCs MEP Cell Cycle staining set (SS2). The plates were printed with 35 row by 20 column MEMAs. A 4x7 pin head printed blocks that are 5x5 spots each. Each spot contains one ECM protein paired with Collagen I. The 46 different ECM proteins in the array are in random locations and have an average of 15 replicates.  Each well has the same printed array.

Images of each well were gathered on a Tecan LS Reloaded laser scanner and Olympus ScanR automated microscope. This staining set includes, DAPI, H3K9me3 (488nm), Fibrillarin(532 and 555) and EdU(635 and 647nm). Data from DAPI staining is only gathered by the ScanR. 

Tecan data is gathered at the spot population level by fitting round regions of interest (ROIs) to each spot. The Tecan data in this report uses the net values defined as the raw ROI value minus the mean of the local background. ScanR data is gathered at the cell level from each cell's nucleus based on image segmentation. There is no background correction applied. ScanR total and mean values intensity values are per cell. Calculated population values for the ScanR are created by summing all of the pixel intensities of all of the cells at each spot.

This dataset has been filtered on nuclear area to exclude objects with an area less than 425. 


```{r setup, echo=FALSE, message=FALSE}
library("ggplot2")
library("data.table")
library("MEMA")
library("grid")

numericMedian <- function(x) as.numeric(median(x))


evalMedians <- function(values, reps){
  tmp <- median(values[reps], na.rm=TRUE)
}

#popDT <- fread("./Annotated Data/LI8X00109PopAnn.txt")

cDT <- fread("./Annotated Data/LIX800109CellAnn.txt")

sDT <- fread("./Annotated Data/LI8X00109SpotAnn.txt")

barcodes <- sort(unique(cDT$Barcode))

#Set a threshold for filtering wells on their QA score
wellQAThresh <- 0.7

#TODO: Read this from sDT
lthresh <- 0.6

# 
# # Clean up the dataset that will be used in the analysis
# popDT <- popDT[!popDT$ShortName =="blank"]
# popDT$ShortName <- gsub("blank","",popDT$ShortName)
# setnames(popDT,"Ligand","LigandAnnotID")
# ms <- gregexpr("^[[:alnum:]]*[^_]", popDT$LigandAnnotID)
# popDT$Ligand <- unlist(regmatches(popDT$LigandAnnotID, ms))


```

\newpage

##QA Scoring of the dataset
Each well is scored for even cell seeding according the count of the DAPI-stained nuclei.

```{r Heatmaps_QAScores, echo=FALSE, fig.width=3.7,fig.height=4}

for (barcode in barcodes){
  DT <-sDT[sDT$Barcode==barcode,]
  #Remove the fiducial entries
  setkey(DT,ShortName)
  DT <- DT[!"fiducial"]

  p <- ggplot(DT, aes(x=ArrayColumn, y=ArrayRow,colour=SpotCellCount))+
    geom_point(size=1)+
    scale_y_reverse()+   scale_x_continuous(breaks= c(min(DT$ArrayColumn),round(mean(c(min(DT$ArrayColumn),max(DT$ArrayColumn)))),max(DT$ArrayColumn)))+
    scale_colour_gradient(low = "white", high = "red")+
    guides(colour = guide_legend("Spot Cell Count", keywidth = .5, keyheight = .5))+
    ggtitle(paste("Spot Cell Count for",unique(DT$CellLine), "cells in plate",unique(DT$Barcode)))+
    xlab("")+ylab("")+theme(axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=1),plot.title = element_text(size = rel(.5)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)))+
    facet_wrap(~Well, ncol=4)
  suppressWarnings(print(p))
  
  p <- ggplot(DT, aes(x=ArrayColumn, y=ArrayRow,colour=LoessSCC))+
    geom_point(size=1)+
    scale_y_reverse()+   scale_x_continuous(breaks= c(min(DT$ArrayColumn),round(mean(c(min(DT$ArrayColumn),max(DT$ArrayColumn)))),max(DT$ArrayColumn)))+
    scale_colour_gradient(low = "white", high = "red")+
    guides(colour = guide_legend("Spot Cell Count", keywidth = .5, keyheight = .5))+
    ggtitle(paste("Loess Model of Spot Cell Count for",unique(DT$CellLine), "cells in plate",unique(DT$Barcode)))+
    xlab("")+ylab("")+theme(axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=1),plot.title = element_text(size = rel(.5)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)))+
    facet_wrap(~Well, ncol=4)
  suppressWarnings(print(p))
  
  
  p <- ggplot(DT, aes(x=SpotCellCount))+
    geom_histogram(binwidth=5)+
    ggtitle(paste("Spot Cell Count for",unique(DT$CellLine), "cells in plate",unique(DT$Barcode)))+xlab("Spot Cell Count")+
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.5)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(.5)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)))+
    facet_wrap(~Well, ncol=4)
  suppressWarnings(print(p))
  
  wellScores <- unique(DT[,list(Well, QAScore=sprintf("%.2f",QAScore))])

  p <- ggplot(DT, aes(x=LoessSCC))+
    geom_histogram(binwidth=.04)+
    geom_vline(xintercept=lthresh, colour="blue")+
    geom_text(data=wellScores, aes(label=paste0("QA\n",QAScore)), x = 1.5, y = 40, size = rel(3), colour="red")+
    ggtitle(paste("Loess Model of Spot Cell Count for",unique(DT$CellLine), "cells in plate",unique(DT$Barcode)))+xlab("Spot Cell Count")+xlim(0,3)+
    theme(axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(.5)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(.5)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)))+
    facet_wrap(~Well, ncol=4)
  suppressWarnings(print(p))
    
  cat(sprintf("Mean QA Score for %9s = %.2f \n",barcode,mean(DT$QAScore)))

}

```

\newpage

##Stain Pseudoimages
The pseudoimages of each well's raw signals are shown in the plots below.

```{r Pseudoimages_all_stains, echo=FALSE, fig.width=3.7,fig.height=4}

for (barcode in sort(unique(sDT$Barcode))){
  DT <-sDT[sDT$Barcode==barcode,]
  #Remove the fiducial entries
  setkey(DT,ShortName)
  DT <- DT[!"fiducial"]

  p <- ggplot(DT, aes(x=ArrayColumn, y=ArrayRow,colour=Mean.Intensity.DAPI))+
    geom_point(size=1)+
    scale_y_reverse()+   scale_x_continuous(breaks= c(min(DT$ArrayColumn),round(mean(c(min(DT$ArrayColumn),max(DT$ArrayColumn)))),max(DT$ArrayColumn)))+
    scale_colour_gradient(low = "white", high = "red")+
    guides(colour = guide_legend("Mena Intensity DAPI", keywidth = .5, keyheight = .5))+
    ggtitle(paste("Mean Intensity DAPI in",unique(DT$CellLine), "cells in plate",unique(DT$Barcode)))+
    xlab("")+ylab("")+theme(axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=1),plot.title = element_text(size = rel(.5)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)))+
    facet_wrap(~Well, ncol=4)
  suppressWarnings(print(p))
  
  p <- ggplot(DT, aes(x=ArrayColumn, y=ArrayRow,colour=Mean.Intensity.Alexa.488))+
    geom_point(size=1)+
    scale_y_reverse()+   scale_x_continuous(breaks= c(min(DT$ArrayColumn),round(mean(c(min(DT$ArrayColumn),max(DT$ArrayColumn)))),max(DT$ArrayColumn)))+
    scale_colour_gradient(low = "white", high = "red",limits=quantile(DT$Mean.Intensity.Alexa.488,probs = c(0,.995),na.rm=TRUE))+
    guides(colour = guide_legend(unique(DT$EndPoint488), keywidth = .5, keyheight = .5))+
    ggtitle(paste(unique(DT$EndPoint488)," in",unique(DT$CellLine), "cells in plate",unique(DT$Barcode)))+
    xlab("")+ylab("")+theme(axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=1),plot.title = element_text(size = rel(.5)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)))+
    facet_wrap(~Well, ncol=4)
  suppressWarnings(print(p))
  
  p <- ggplot(DT, aes(x=ArrayColumn, y=ArrayRow,colour=Mean.Intensity.Alexa.555))+
    geom_point(size=1)+
    scale_y_reverse()+   scale_x_continuous(breaks= c(min(DT$ArrayColumn),round(mean(c(min(DT$ArrayColumn),max(DT$ArrayColumn)))),max(DT$ArrayColumn)))+
    scale_colour_gradient(low = "white", high = "red",limits=quantile(DT$Mean.Intensity.Alexa.555,probs = c(0,.995),na.rm=TRUE))+
    guides(colour = guide_legend(unique(DT$EndPoint555), keywidth = .5, keyheight = .5))+
    ggtitle(paste(unique(DT$EndPoint555)," in",unique(DT$CellLine), "cells in plate",unique(DT$Barcode)))+
    xlab("")+ylab("")+theme(axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=1),plot.title = element_text(size = rel(.5)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)))+
    facet_wrap(~Well, ncol=4)
  suppressWarnings(print(p))
  
  p <- ggplot(DT, aes(x=ArrayColumn, y=ArrayRow,colour=Mean.Intensity.Alexa.647))+
    geom_point(size=1)+
    scale_y_reverse()+   scale_x_continuous(breaks= c(min(DT$ArrayColumn),round(mean(c(min(DT$ArrayColumn),max(DT$ArrayColumn)))),max(DT$ArrayColumn)))+
    scale_colour_gradient(low = "white", high = "red",limits=quantile(DT$Mean.Intensity.Alexa.647,probs = c(0,.995),na.rm=TRUE))+
    guides(colour = guide_legend(unique(DT$EndPoint647), keywidth = .5, keyheight = .5))+
    ggtitle(paste(unique(DT$EndPoint647)," in",unique(DT$CellLine), "cells in plate",unique(DT$Barcode)))+
    xlab("")+ylab("")+theme(axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=1),plot.title = element_text(size = rel(.5)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)))+
    facet_wrap(~Well, ncol=4)
  suppressWarnings(print(p))
}

```

##Filtering
No wells are filtered from this dataset.


```{r Filtering, echo=FALSE}

# passedQAWells <- unique(sDT[sDT$QAScore > wellQAThresh,list(Barcode,Well)])
# 
# 
# setkey(cDT,Barcode,Well)
# cDT <- merge(cDT,passedQAWells)
# 
# setkey(sDT,Barcode,Well)
# sDT <- merge(sDT,passedQAWells)


```

##Univariate Signal Distributions
The first step in the EDA is to look at the univariate cell-level signal responses.

Density is calculated from the number of nuclei centers within a circle about each cell's nuclear center. The mean nuclear radius for these PC3 cells is 40 pixels and the density calculation is based on a radius of 160 pixels.

```{r Univariate Signals, echo=FALSE, fig.width=4}

for (barcode in barcodes){
  setkey(cDT, Barcode)
  DT <- cDT[barcode]

  p <- ggplot(DT, aes(x=Mean.Intensity.Alexa.488))+
    geom_histogram(binwidth = 10)+
    ggtitle(paste(unique(DT$EndPoint488),"Signal in", unique(DT$CellLine), "cells in plate",unique(DT$Barcode)))+xlab("Mean.Intensity.Alexa.488")+
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.5)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(.5)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)))+
    facet_wrap(~Well, ncol=4)
  suppressWarnings(print(p))
  
    p <- ggplot(DT, aes(x=Mean.Intensity.Alexa.555))+
    geom_histogram(binwidth = 10)+
    ggtitle(paste(unique(DT$EndPoint555),"Signal in", unique(DT$CellLine), "cells in plate",unique(DT$Barcode)))+xlab("Mean.Intensity.Alexa.555")+
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.5)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(.5)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)))+
    facet_wrap(~Well, ncol=4)
  suppressWarnings(print(p))
  
    p <- ggplot(DT, aes(x=Mean.Intensity.Alexa.647))+
    geom_bar(binwidth=.5)+
    ggtitle(paste(unique(DT$EndPoint647),"Signal in", unique(DT$CellLine), "cells in plate",unique(DT$Barcode)))+xlab("Mean.Intensity.Alexa.647")+
  xlim(0,60)+
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.5)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(.5)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)))+
    facet_wrap(~Well, ncol=4)
  suppressWarnings(print(p))
  
      p <- ggplot(DT, aes(x=Density))+
    geom_histogram(binwidth = .2)+
    ggtitle(paste("Density of", unique(DT$CellLine), "cells in plate",unique(DT$Barcode)))+xlab("Density")+
  #xlim(0,60)+
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.5)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(.5)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)))+
    facet_wrap(~Well, ncol=4)
  suppressWarnings(print(p))
  
}
```


##EdU Proliferation and Cell Cycle Plots
Proliferation is measured by EdU uptake during the end of incubation. Plotting the mean EDU per cell against the Total DAPI per cell yields the characteristic horse shoe proliferation pattern of EdU staining. The blue dots represent cells gated as EdU positive. 

The middle and bottom plot show the percent of cells that are EdU positive at each spot vs spot cell count and cell density.

```{r EdU_Horseshoe_plots,echo=FALSE, message=FALSE, warnings=FALSE, fig.width=8,fig.height=6}

for(barcode in barcodes){
  DT <- cDT[cDT$Barcode==barcode]
  p <- ggplot(DT,aes(x=Total.Intensity.DAPI,y=log2(Mean.Intensity.Alexa.647), colour=EdUPositive))+
    xlim(0,quantile(DT$Total.Intensity.DAPI,probs=.95, na.rm=TRUE))+
    geom_point(size=.5)+
    geom_rug(col=rgb(.5,0,0,alpha=.01))+
    #scale_colour_manual(values = c("black","blue"))+
    facet_grid(.~Well)+
    guides(colour=FALSE)+
    ggtitle(paste("EdU Proliferation Signal in",barcode))+
    xlab("Total DAPI Intensity per Cell")+ylab("Mean EdU per Cell (log2)")+
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)))
 suppressWarnings(print(p))
 
}


for(barcode in barcodes){
  DT <- sDT[sDT$Barcode==barcode]
  p <- ggplot(DT,aes(x=SpotCellCount, y=EdUPositivePercent, colour=Density))+
    geom_point(size=2)+
    geom_rug(col=rgb(.5,0,0,alpha=.1))+
    facet_grid(.~Well)+
    ggtitle(paste("EdU Proliferation Signal vs. Spot Cell Count and Density in",barcode))+
    #xlab("Density")+ylab("Mean EdU per Cell (log2)")+
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)))
 suppressWarnings(print(p))
 
   p <- ggplot(DT,aes(x=Density, y=EdUPositivePercent, colour=SpotCellCount))+
    #xlim(0,quantile(DT$Total.Intensity.DAPI,probs=.95, na.rm=TRUE))+
    geom_point(size=1)+
    geom_rug(col=rgb(.5,0,0,alpha=.1))+
    #scale_colour_manual(values = c("black","blue"))+
    facet_grid(.~Well)+
    guides(colour=FALSE)+
    #ggtitle(paste("EdU Proliferation Signal in",barcode))+
    #xlab("Density")+ylab("Mean EdU per Cell (log2)")+
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)))
 suppressWarnings(print(p))
}

```

##Raw Signals vs Spot Cell Count
 
 
 
```{r signals_vs_SCC,echo=FALSE, message=FALSE, warnings=FALSE, fig.width=8,fig.height=6}
 
 for(barcode in barcodes){
     p <- ggplot(DT,aes(x=SpotCellCount, y=log2(Mean.Intensity.Alexa.488), colour=Density))+
    geom_point(size=1, alpha=.7)+stat_smooth(method="gam",se = FALSE)+
    geom_rug(col=rgb(.5,0,0,alpha=.1))+
    facet_grid(.~Well)+
    ggtitle(paste("H3K9me3 vs. Spot Cell Count and Density in",barcode))+
    xlab("Spot Cell Count")+ylab("Mean H3K9me3 per Cell (log2)")+
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)))
 suppressWarnings(print(p))
 
      p <- ggplot(DT,aes(x=SpotCellCount, y=log2(Mean.Intensity.Alexa.555), colour=Density))+
    geom_point(size=1, alpha=.7)+stat_smooth(method="gam",se = FALSE)+
    geom_rug(col=rgb(.5,0,0,alpha=.1))+
    facet_grid(.~Well)+
    ggtitle(paste("Fibrillarin vs. Spot Cell Count and Density in",barcode))+
    xlab("Spot Cell Count")+ylab("Mean Fibrillarin per Cell (log2)")+
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)))
 suppressWarnings(print(p))
 
}

```

```{r Read and clean spotmetadata, echo=TRUE, message=FALSE, warnings=FALSE}

#Read in the spot metadata from the gal file
smd <- readSpotMetadata("./Raw Data and Metadata/20150515_LI8X001_v1.gal")

#Make a short name for labeling in plots
smd$ShortName <- gsub("_.*","",smd$Name)
smd$ShortName <- gsub("-","blank",smd$ShortName)

#Add the print order and deposition number to the metadata
ldf <- readLogData("./Raw Data and Metadata/20150512-112336.xml")
setkey(ldf, Row, Column)
setkey(smd,Row,Column,Block)
spotMetadata <- ldf[smd]
setkey(spotMetadata,Spot)
#Make a non-rotated version of the spot metadata
spotMetadata180 <- rotateMetadata(spotMetadata)
setkey(spotMetadata180,Spot)

```


##Replicate Count
The LINCs MEMA has an average of 15 replicates with a range from 13 to 19.  

```{r Layout Replicate Count,echo=FALSE, message=FALSE, warnings=FALSE, fig.width=6.5, fig.height=2.5}

p <- ggplot(smd, aes(x=ShortName))+
  geom_bar(width=.8)+geom_hline(yintercept = mean(table(smd$ShortName)), colour="blue")+
  ggtitle(" \n\nCount of Replicate ECM Proteins In LINCs MEMA")+
  xlab("Printed ECM Protein")+ylab("Number of spots")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.8)),axis.title.x = element_text(size=rel(.8)),axis.title.y = element_text(size=rel(.8)),plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.5)))

print(p)

for (well in unique(sDT$Well)){
DT <- sDT[sDT$Well==well]
p <- ggplot(DT, aes(x=ShortName))+
  geom_bar(width=.8)+geom_hline(yintercept = mean(table(DT$ShortName)), colour="blue")+
  ggtitle(paste(" \n\nCount of Replicate ECM Proteins In",well,"ScanR Data"))+
  xlab("Printed ECM Protein")+ylab("Number of spots")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.8)),axis.title.x = element_text(size=rel(.8)),axis.title.y = element_text(size=rel(.8)),plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.5)))

print(p)
}

```
