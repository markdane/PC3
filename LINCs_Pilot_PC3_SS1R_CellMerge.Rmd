---
title: "Structure and Morphology Cell Level MEMA Data"
author: "Mark Dane"
date: "`r Sys.Date()`"
output: pdf_document
---
##Summary
This dataset contains cell-level data for LINCs MEP Structure and Morphology staining set (SS1). The plates were printed with 35 row by 20 column MEMAs. A 4x7 pin head printed blocks that are 5x5 spots each. Each spot contains one ECM protein paired with Collagen I. The 46 different ECM proteins in the array are in random locations and have an average of 15 replicates.  Each well has the same printed array.

Images of each well were gathered on a Tecan LS Reloaded laser scanner and Olympus ScanR automated microscope. This staining set includes, DAPI, phalloidin (488nm), CellMask (532 and 555nm) and MitoTracker (635 and 647nm). Data from DAPI staining is only gathered by the ScanR. 

Tecan data is gathered at the spot population level by fitting round regions of interest (ROIs) to each spot. The Tecan data in this report uses the net values defined as the raw ROI value minus the mean of the local background. ScanR data is gathered at the cell level from each cell's nucleus based on image segmentation. There is no background correction applied. ScanR total and mean values intensity values are per cell. Calculated population values for the ScanR are created by summing all of the pixel intensities of all of the cells at each spot.

This dataset has been filtered on nuclear area to exclude objects with an area less than 425. 



```{r setup, echo=FALSE, message=FALSE}
library("ggplot2")
library("limma")
library("MEMA")
library("data.table")
library("parallel")
library("grid")


integerMedian <- function(x) as.integer(median(x))

numericMedian <- function(x) as.numeric(median(x))

#TODO Move these functions into the MEMA package
calcQAScore <- function(DT, threshold, maxNrSpot=700, value){
  QAScore <- (nrow(DT)-sum(DT[,value,with=FALSE] < threshold))/maxNrSpot
  return (QAScore)
}

#' count the number of cells within a euclidean distance from each cell
spotCellDensities <- function(spot,radius=(max(spot$X)-min(spot$X))/5) {
  distMatrix <- as.matrix(dist(spot[,list(X,Y)]))
  count <- apply(distMatrix, 2, function(x){sum(x <= radius) - 1})
  cellDensity <- count/(pi*radius^2)
  return(cellDensity)
}


```

```{r Read and clean spotmetadata, echo=FALSE, message=FALSE, warnings=FALSE}

#Read in the spot metadata from the gal file
smd <- readSpotMetadata("./Raw Data and Metadata/20150515_LI8X001_v1.gal")

#Make a short name for labeling in plots
smd$ShortName <- gsub("_.*","",smd$Name)
smd$ShortName <- gsub("-","blank",smd$ShortName)

#Add the print order and deposition number to the metadata
ldf <- readLogData("./Raw Data and Metadata/20150512-112336.xml")
setkey(ldf, Row, Column)
setkey(smd,Row,Column,Block)
spotMetadata <- ldf[smd]
setkey(spotMetadata,Spot)
#Make a non-rotated version of the spot metadata
spotMetadata180 <- rotateMetadata(spotMetadata)
setkey(spotMetadata180,Spot)

```

```{r ScanR merge, normalize and QA, echo=FALSE, message=FALSE, warnings=FALSE}
#The next steps are to bring in the well metadata, the print order and the ScanR data

barcodes <- c("LI8X00101")
barcodeFiles <- grep(pattern = paste(barcodes,collapse = "|"), dir(path = "Raw Data and Metadata/",ignore.case = TRUE), value=TRUE)
cellDataFiles <- grep(pattern = "Cyto10|Main", barcodeFiles, value=TRUE,ignore.case = TRUE)

expDTList <- lapply(barcodes, function(barcode){
  plateDataFiles <- grep(barcode,cellDataFiles,value = TRUE)
  wells <- unique(strsplit2(split = "_",plateDataFiles)[,2])
  wellDataList <- lapply(wells,function(well){
    wellDataFiles <- grep(well,plateDataFiles,value = TRUE)
    mainDataFile <- grep("main",wellDataFiles,value=TRUE,ignore.case = TRUE)
    cytoDataFile <- grep("Cyto10",wellDataFiles,value=TRUE,ignore.case = TRUE)
    #Read in and merge the main and cyto data for each well
    mainDT <- makeValidColumnNames(fread(paste0("./Raw Data and Metadata/",mainDataFile),stringsAsFactors=FALSE))
    cytoDT <- makeValidColumnNames(fread(paste0("./Raw Data and Metadata/",cytoDataFile),stringsAsFactors=FALSE))
    #Add a cyto prefix to the parameters
    parmNames <- grep(pattern="(Total.Intensity.DAPI|Mean.Intensity.DAPI|Total.Intensity.Alexa.488|Mean.Intensity.Alexa.488|Mean.Intensity.Alexa.555|Mean.Intensity.Alexa.647|Mean.Intensity.Alexa.555|Area)",x=names(cytoDT),value=TRUE)
    setnames(cytoDT, parmNames, paste0("Cyto.",parmNames))
    #Merge the cyto data to the main data using  Parent.Object.ID..MO
    # in the cyto file and Object.ID in the main file
    setkey(mainDT,key="Object.ID")
    setkey(cytoDT,key="Parent.Object.ID..MO")
    DT <- mainDT[cytoDT]
    #clean up the column names
    DT <- DT[,c("Position","Parent.Object.ID..Well","Parent.Trace.ID","i.Object.ID","i.Parent.Trace.ID") :=NULL]
    setnames(DT,"Well","Spot")
    #Add the well name as a parameter
    DT$Well <- well
    #Merge the data with its metadata based on the row it's in
    m <- regexpr("[[:alpha:]]",well)
    row <- regmatches(well,m)
    setkey(DT,Spot)
    DT <- switch(row,A = merge(DT,spotMetadata,all=TRUE),B = merge(DT,spotMetadata180,all=TRUE))
    #Add the well name again to fill in NA values
    DT$Well <- well
    return(DT)
  })
  
  #Create the cell data.table with spot metadata for the plate 
  pcDT <- rbindlist(wellDataList, fill = TRUE)
  
  #Read the well metadata from a multi-sheet Excel file
  wellMetadata <- data.table(readMetadata(paste0("./Raw Data and Metadata/",barcode,".xlsx")), key="Well")  
  #merge well metadata with the data and spot metadata
  #browser()
  pcDT <- merge(pcDT,wellMetadata,by = "Well")
  pcDT <- pcDT[,Barcode := barcode]
  #Count the cells at each spot
  pcDT<-pcDT[,SpotCellCount := length(Object.ID),by="Barcode,Well,Spot"]
  #Calculate a total cytoplasmic intensity for each mean cyto intensity
  nuclearMeanIntensities <- grep("^Mean.Intensity.Alexa",colnames(pcDT),value=TRUE)
  for(nuclearMeanIntensity in nuclearMeanIntensities){
    total <- pcDT$Area*switch(nuclearMeanIntensity,            Mean.Intensity.Alexa.488=pcDT$Mean.Intensity.Alexa.488,
                              Mean.Intensity.Alexa.555=pcDT$Mean.Intensity.Alexa.555,
                              Mean.Intensity.Alexa.647=pcDT$Mean.Intensity.Alexa.647)
    pcDT <- pcDT[,sub("Mean","Total",nuclearMeanIntensity) := total]
  }
  #Create population level signals
  pcDT <-pcDT[,Population488 := sum(Cyto.Mean.Intensity.Alexa.488*Area),by="Barcode,Well,Spot"]
  pcDT <-pcDT[,Population555 := sum(Cyto.Mean.Intensity.Alexa.555*Area),by="Barcode,Well,Spot"]
  pcDT <-pcDT[,Population647 := sum(Cyto.Mean.Intensity.Alexa.647*Area),by="Barcode,Well,Spot"]
  
  loessModel <- function (data, value, span) 
  {
    #browser()
    if(nrow(data)==1) return(0)
    dataModel <- loess(as.formula(paste0(value, " ~ ArrayRow+ArrayColumn")),data, span = span)
    dataPredicted <- predict(dataModel)
    predictedMedian <- median(dataPredicted, na.rm = TRUE)
    dataNormed <- dataPredicted/predictedMedian
  }
  
  #Add the loess model of the SpotCellCount on a per well basis
  pcDT <- pcDT[,LoessSCC := loessModel(.SD,value="SpotCellCount",span=.1), by="Barcode,Well"]
  
  #Median normalize to the plate's control well for each channel's value
  pcDT <- pcDT[,Mean.Intensity.DAPI.MedNorm := normWellsWithinPlate(.SD, value="Mean.Intensity.DAPI", baseECM = ".*",baseGF = "HighSerum"), by="Barcode"]
  pcDT <- pcDT[,Cyto.Mean.Intensity.Alexa.488.MedNorm := normWellsWithinPlate(.SD, value="Cyto.Mean.Intensity.Alexa.488", baseECM = ".*",baseGF = "HighSerum"), by="Barcode"]
  pcDT <- pcDT[,Cyto.Mean.Intensity.Alexa.555.MedNorm := normWellsWithinPlate(.SD, value="Cyto.Mean.Intensity.Alexa.555", baseECM = ".*",baseGF = "HighSerum"), by="Barcode"]
  pcDT <- pcDT[,Cyto.Mean.Intensity.Alexa.647.MedNorm := normWellsWithinPlate(.SD, value="Cyto.Mean.Intensity.Alexa.647", baseECM = ".*",baseGF = "HighSerum"), by="Barcode"]
  pcDT <- pcDT[,SpotCellCount.MedNorm := normWellsWithinPlate(.SD, value="SpotCellCount", baseECM = ".*",baseGF = "HighSerum"), by="Barcode"]
  
  #Filter out debris based on nuclear area
  nuclearAreaThresh <- 425
  pcDT <- pcDT[pcDT$Area >nuclearAreaThresh,]
  
  return(pcDT)
})
cDT <- rbindlist(expDTList, fill = TRUE)
cDT$Total.Intensity.DAPI <- cDT$Area*cDT$Mean.Intensity.DAPI

#Create a display name for the ligands
setnames(cDT,"Ligand","LigandAnnotID")
ms <- gregexpr("^[[:alnum:]]*[^_]", cDT$LigandAnnotID)
cDT$Ligand <- unlist(regmatches(cDT$LigandAnnotID, ms))

#Add the cell density
#Average nuclear radius is 40 so touching nuclei are 80 apart
#Set neighborhood as 4 nuclei radii
cDT <- cDT[,Density:=spotCellDensities(.SD, radius=160)*10000,by="Barcode,Well,Spot"]


write.table(cDT, paste0("./Annotated Data/LI8X00101_CellAnn.txt"), sep = "\t",row.names = FALSE, quote=FALSE)

#Summarize cell data to spot level (sl) by taking the medians of the parameters
slNames<-grep(pattern="(Total.Intensity.DAPI|Mean.Intensity.DAPI|Total.Intensity.Alexa.488|Mean.Intensity.Alexa.488|Mean.Intensity.Alexa.555|Mean.Intensity.Alexa.647|Mean.Intensity.Alexa.555|Area|SpotCellCount|EdUPositivePercent|Population488|Population555|Population647|Loess|Density|Z|Barcode|^Spot$|^Well$)",x=names(cDT),value=TRUE)
slKeep<-cDT[,slNames,with=FALSE]
slDT<-slKeep[,lapply(.SD,numericMedian),keyby="Barcode,Well,Spot"]

#Merge back in the spot and well metadata
mDT <- cDT[,list(Row,Column,PrintOrder,Depositions,Block,Name,ID,ArrayRow,ArrayColumn,Spot,ShortName,Well,CellLine,Ligand,LigandAnnotID,EndPoint488,EndPoint555,EndPoint647,WellIndex),keyby="Barcode,Well,Spot"]
slDT <- mDT[slDT, mult="first"]
#TODO: Determine a cleaner way to not duplicate the key columns
slDT <-slDT[,Well.1:=NULL]
slDT <-slDT[,Spot.1:=NULL]

#Create random versions of the signals to compare against
set.seed(1234)
slDT <- slDT[,SpotCellCountRandom := randomizePositions(SpotCellCount),by="Barcode,Well"]
set.seed(1235)
slDT <- slDT[,Population488Random := randomizePositions(Population488),by="Barcode,Well"]
set.seed(1236)
slDT <- slDT[,Population555Random := randomizePositions(Population555),by="Barcode,Well"]
set.seed(1237)
slDT <- slDT[,Population647Random := randomizePositions(Population647),by="Barcode,Well"]

#Calculate CVs for each set of replicates in the ScanR data
cvNames<-grep(pattern="(Intensity|Area|SpotCellCount|Population|EdUPositivePercent|Barcode|^Name$|^Well$)",x=names(slDT),value=TRUE)
cvKeep<-slDT[,cvNames,with=FALSE]
repSpots<-c('Name','Well','Barcode')
cv<-cvKeep[,lapply(.SD,CV),by=repSpots]
data.table::setnames(cv,colnames(cv), paste0("CV.",colnames(cv)))
data.table::setkey(cv,CV.Well,CV.Name, CV.Barcode)
data.table::setkey(slDT,Well,Name,Barcode)
slDT <- slDT[cv]

#Add well level QA Scores
lthresh <- 0.6
  slDT <- slDT[,QAScore := calcQAScore(.SD,threshold=lthresh,maxNrSpot = max(cDT$ArrayRow)*max(cDT$ArrayColumn),value="LoessSCC"),by="Barcode,Well"]

write.table(slDT, paste0("./Annotated Data/LI8X00101_SpotAnn.txt"), sep = "\t",row.names = FALSE, quote=FALSE)


```

