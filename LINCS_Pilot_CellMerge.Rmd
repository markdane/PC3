---
title: "Annotate Cell-Level MEP-LINCs Data"
author: "Mark Dane"
date: "`r Sys.Date()`"
output: pdf_document
---
##Summary
This script prepares cell-level data and metadata for the LINCs Analysis Pipeline. 

In the code, the variable ss determines which staining set (SS1, SS2 or SS3) to merge. All .txt data files in the ./Cell/Raw Data folder will be merged
with the well (xlsx) and log (XML) data from the ./Metadata folder.

This merging assumes that the actual, physical B row wells (B01-B04) have been printed upside-down. That is, rotated 180 degrees resulting in the spot 1,1 being in the lower right corner instead of the upper left corner. The metadata is matched to the actual printed orientation.

The data is filtered to remove objects with area less than 1000 pixels.

In addition to merging the metadata with the cell-level data, several types of derived parameters are added. These include:

Cell Density based on the number of nuclear centers within a radius around each nucleus.
Normalized intensity values calculated by dividing each intensity value by the median of the corresponding intensity value in the control well of the same plate. 

Some parameters are clustered or gated into two or more classifications. For example, cells are classified as EdU+ or EdU-, 2N and less or 4N and more DNA.
Each cell does not have every derived parameter as each staining set has unique endpoints.

The data is summarized by the median of the parameter at each spot. Then additional derived values are added to this spot-level dataset:

The Spot Cell Count for the number of cells at each spot
Loess models of the spot cell count that capture regional information about cell seeding.

The staining sets are summarized by the medians of their normalized replicate values then combined to the MEP-level within each cell line.


```{r setup, echo=FALSE, message=FALSE}
library("limma")
library("MEMA")
library("data.table")
library("parallel")
#library("grid")

#Select a staining set
ss <- "SS2"
densityThresh <- 0.4
outerThresh <- 0.5

```


```{r Read and clean spotmetadata, echo=FALSE}

#Read in the spot metadata from the gal file
smd <- readSpotMetadata(paste0("./",ss,"/Metadata/20150515_LI8X001_v1.gal"))
#Make a short name from the content names for labeling in plots
smd$ShortName <- gsub("_.*","",smd$Name)
smd$ShortName <- gsub("-","blank",smd$ShortName)

#Add the print order and deposition number to the metadata
  ldf <- readLogData(paste0("./",ss,"/Metadata/20150512-112336.xml"))
  spotMetadata <- merge(smd,ldf, all=TRUE)
  setkey(spotMetadata,Spot)
#Make a rotated version of the spot metadata
spotMetadata180 <- rotateMetadata(spotMetadata)
ARowMetadata <- data.table(spotMetadata,Well=rep(c("A01", "A02","A03","A04"),each=nrow(spotMetadata)))
BRowMetadata <- data.table(spotMetadata180,Well=rep(c("B01", "B02","B03","B04"),each=nrow(spotMetadata180)))

```


```{r ScanR merge_normalize and QA, echo=FALSE, message=FALSE, warnings=FALSE}
#The next steps are to bring in the well metadata, the print order and the ScanR data

cellDataFiles <- dir(paste0(ss,"/Cell/Raw Data"),full.names = TRUE)
splits <- strsplit2(strsplit2(cellDataFiles,split = "_")[,1],"/")
barcodes <- unique(splits[,ncol(splits)])

expDTList <- lapply(barcodes, function(barcode){
  #browser()
  plateDataFiles <- grep(barcode,cellDataFiles,value = TRUE)
  wells <- unique(strsplit2(split = "_",plateDataFiles)[,2])
  wellDataList <- lapply(wells,function(well){
    #browser()
    wellDataFiles <- grep(well,plateDataFiles,value = TRUE)
    mainDataFile <- grep("main",wellDataFiles,value=TRUE,ignore.case = TRUE)
    cytoDataFile <- grep("Cyto10",wellDataFiles,value=TRUE,ignore.case = TRUE)
    
    #Read in and merge the main and cyto data for each well
    mainDT <- makeValidColumnNames(fread(mainDataFile,stringsAsFactors=FALSE))
    
    if(length(cytoDataFile)) {
    cytoDT <- makeValidColumnNames(fread(cytoDataFile,stringsAsFactors=FALSE))
    #Add a cyto prefix to the parameters
    parmNames <- grep(pattern="(Total.Intensity.DAPI|Mean.Intensity.DAPI|Total.Intensity.Alexa.488|Mean.Intensity.Alexa.488|Mean.Intensity.Alexa.555|Mean.Intensity.Alexa.647|Mean.Intensity.Alexa.555|Area)",x=names(cytoDT),value=TRUE)
    setnames(cytoDT, parmNames, paste0("Cyto.",parmNames))
    #Merge the cyto data to the main data using  Parent.Object.ID..MO
    # in the cyto file and Object.ID in the main file
    setkey(mainDT,key="Object.ID")
    setkey(cytoDT,key="Parent.Object.ID..MO")
    DT <- mainDT[cytoDT]
    } else {
      DT <- mainDT
    }
    
    #clean up the column names
    deleteNames <- colnames(DT)[colnames(DT) %in% c("Position","Parent.Object.ID..Well","Parent.Trace.ID","i.Object.ID","i.Parent.Trace.ID")]
    DT <- DT[,deleteNames :=NULL, with = FALSE]
    
    setnames(DT,"Well","Spot")
    #Add the well name as a parameter
    DT$Well <- well
    #Merge the data with its metadata based on the row it's in
    m <- regexpr("[[:alpha:]]",well)
    row <- regmatches(well,m)
    setkey(DT,Spot)
    DT <- switch(row,A = merge(DT,spotMetadata,all=TRUE),B = merge(DT,spotMetadata180,all=TRUE))
    #Add the well name again to fill in NA values
    DT$Well <- well
    return(DT)
  })
  
  #Create the cell data.table with spot metadata for the plate 
  pcDT <- rbindlist(wellDataList, fill = TRUE)
  
  #Read the well metadata from a multi-sheet Excel file
  wellMetadata <- data.table(readMetadata(paste0(ss,"/Metadata/",barcode,".xlsx")), key="Well")  
  #merge well metadata with the data and spot metadata
  #browser()
  pcDT <- merge(pcDT,wellMetadata,by = "Well")
  pcDT <- pcDT[,Barcode := barcode]
  #Count the cells at each spot
  pcDT<-pcDT[,SpotCellCount := length(Object.ID),by="Barcode,Well,Spot"]
 
  #Add the loess model of the SpotCellCount on a per well basis
  pcDT <- pcDT[,LoessSCC := loessModel(.SD,value="SpotCellCount",span=.1), by="Barcode,Well"]
  
  #If there is a highSerum well in the plate, use it for normalization
  if(sum(pcDT$Ligand=="HighSerum")){
  intensityNames <- grep("Intensity",colnames(pcDT), value=TRUE)
  for(intensityName in intensityNames){
  #Median normalize to the plate's control well for each channel's value
  pcDT <- pcDT[,paste0(intensityName,".MedNorm") := normWellsWithinPlate(.SD, value=intensityName, baseECM = ".*",baseGF = "HighSerum"), by="Barcode"]
  }
  
  pcDT <- pcDT[,SpotCellCount.MedNorm := normWellsWithinPlate(.SD, value="SpotCellCount", baseECM = ".*",baseGF = "HighSerum"), by="Barcode"]
  }

  
  #Filter out debris based on nuclear area
  nuclearAreaThresh <- 1000
  pcDT <- pcDT[pcDT$Area >nuclearAreaThresh,]
  
  return(pcDT)
})

cDT <- rbindlist(expDTList, fill = TRUE)

```

```{r, echo=FALSE, message=FALSE, warnings=FALSE}

cDT$Total.Intensity.DAPI <- cDT$Area*cDT$Mean.Intensity.DAPI

#Create a display name for the ligands
setnames(cDT,"Ligand","LigandAnnotID")
ms <- gregexpr("^[[:alnum:]]*[^_]", cDT$LigandAnnotID)
cDT$Ligand <- unlist(regmatches(cDT$LigandAnnotID, ms))

#Create a display name for the ECM Proteins
cDT$ECMpAnnotID <- cDT$Name
ms <- gregexpr("^[[:alnum:]]*[^_]", cDT$ECMpAnnotID)
cDT$ECMp <- unlist(regmatches(cDT$ECMpAnnotID, ms))

#Add the local cartesian and polar coordinates, wedge, Density, and classifications for Sparse, OuterCell and Perimeter
setkey(cDT,Barcode,Well,Spot,Object.ID)
cDT <- merge(cDT,setkey(positionParms(cDT),Barcode,Well,Spot,Object.ID))


#Add a spot level normalizations on the intensity values
if(ss %in% c("SS1", "SS3")){
  cDT <- cDT[,Cyto.Mean.Intensity.Alexa.488.SpotNorm := Cyto.Mean.Intensity.Alexa.488/median(Cyto.Mean.Intensity.Alexa.488, na.rm=TRUE), by="Barcode,Well,Spot"]
  cDT <- cDT[,Cyto.Mean.Intensity.Alexa.555.SpotNorm := Cyto.Mean.Intensity.Alexa.555/median(Cyto.Mean.Intensity.Alexa.555, na.rm=TRUE), by="Barcode,Well,Spot"]
  cDT <- cDT[,Cyto.Mean.Intensity.Alexa.647.SpotNorm := Cyto.Mean.Intensity.Alexa.647/median(Cyto.Mean.Intensity.Alexa.647, na.rm=TRUE), by="Barcode,Well,Spot"]
} else if (ss == "SS2"){
  cDT <- cDT[,Mean.Intensity.Alexa.488.SpotNorm := Mean.Intensity.Alexa.488/median(Mean.Intensity.Alexa.488, na.rm=TRUE), by="Barcode,Well,Spot"]
 DT <- cDT[,Mean.Intensity.Alexa.555.SpotNorm := Mean.Intensity.Alexa.555/median(Mean.Intensity.Alexa.555, na.rm=TRUE), by="Barcode,Well,Spot"]
 DT <- cDT[,Mean.Intensity.Alexa.647.SpotNorm := Mean.Intensity.Alexa.647/median(Mean.Intensity.Alexa.647, na.rm=TRUE), by="Barcode,Well,Spot"]
    
  cDT <- cDT[,EdUPositive := kmeansCluster(.SD, value="Mean.Intensity.Alexa.647.MedNorm", ctrlLigand = "HighSerum"), by="Barcode"]
  #Calculate the EdU Positive Percent at each spot
  cDT <- cDT[,EdUPositiveProportion := sum(EdUPositive)/length(Object.ID),by="Barcode,Well,Spot"]
} else stop("Invalid ss parameter")

# Eliminate Variations in the Endpoint metadata
endpointNames <- grep("End",colnames(cDT), value=TRUE)
endpointWL <- regmatches(endpointNames,regexpr("[[:digit:]]{3}",endpointNames))
setnames(cDT,endpointNames,paste0("Endpoint",endpointWL))

#Cell cycle on total DNA under developent and not implemented
# MclustCluster <- function(x){
#   #browser()
#   mod <- densityMclust(x,G=2, modelNames = "E")
#   return(mod[["classification"]])
# }
# 
# mixtoolCluster <- function(x){
#   browser()
#   histinfo <- hist(x,breaks=100)
#   
#   mod <- normalmixEM(x, sd.constr=c("a","a"))
#   return(mod[["classification"]])
# }
# 
# #Set 2N and 4N DNA status
# cDT <- cDT[,DNA4N := kmeansCluster(Total.Intensity.DAPI), by="Barcode,Well"]

#Create staining set specific derived parameters.
if(ss == "SS1"){
  
} else if(ss== "SS2") {



  
} else if(ss == "SS3"){
  
} else stop("invalid staining set")
```

```{r, echo=FALSE, message=FALSE, warnings=FALSE, eval=TRUE}

write.table(cDT, paste0(ss,"/Cell/Annotated Data/",unique(cDT$CellLine),"_",ss,"_","CellAnn.txt"), sep = "\t",row.names = FALSE, quote=FALSE)
```

```{r SpotLevelData, echo=FALSE}

#Summarize cell data to spot level (sl) by taking the medians of the parameters
slNames<-grep(pattern="(Total|Mean|Elongation|Area|SpotCellCount|EdUPositive|RadialPosition|Population|Loess|Density|Z|Barcode|^Spot$|^Well$)",x=names(cDT),value=TRUE)
slKeep<-cDT[,slNames,with=FALSE]
slDT<-slKeep[,lapply(.SD,numericMedian),keyby="Barcode,Well,Spot"]

#Merge back in the spot and well metadata
mDT <- cDT[,list(Row,Column,PrintOrder,Depositions,Block,Name,ID,ArrayRow,ArrayColumn,ShortName,CellLine,Ligand,LigandAnnotID,Endpoint488,Endpoint555,Endpoint647,DAPI,WellIndex,ECMpAnnotID,ECMp),keyby="Barcode,Well,Spot"]
slDT <- mDT[slDT, mult="first"]

#Calculate CVs for each set of replicates in the ScanR data
cvNames<-grep(pattern="(Intensity|Area|SpotCellCount|Population|EdUPositivePercent|Barcode|^Name$|^Well$)",x=names(slDT),value=TRUE)
cvKeep<-slDT[,cvNames,with=FALSE]
repSpots<-c('Name','Well','Barcode')
cv<-cvKeep[,lapply(.SD,CV),by=repSpots]
data.table::setnames(cv,colnames(cv), paste0("CV.",colnames(cv)))
data.table::setkey(cv,CV.Well,CV.Name, CV.Barcode)
data.table::setkey(slDT,Well,Name,Barcode)
slDT <- slDT[cv]

#Add well level QA Scores
lthresh <- 0.6
  slDT <- slDT[,QAScore := calcQAScore(.SD,threshold=lthresh,maxNrSpot = max(cDT$ArrayRow)*max(cDT$ArrayColumn),value="LoessSCC"),by="Barcode,Well"]

```

```{r, echo=FALSE, eval=TRUE}
  
write.table(slDT, paste0(ss,"/Cell/Annotated Data/",unique(slDT$CellLine),"_",ss,"_","CellSpotAnn.txt"), sep = "\t",row.names = FALSE, quote=FALSE)

```

```{r MEPLevelData, echo=FALSE}
  
  
  #Summarize spot level data to MEP level by taking the medians of the parameters
  mepNames<-grep(pattern="(^Total|^Mean|Elongation|^Area|Z|^SpotCellCount|Loess|RadialPosition|EdUPositiveProportion|Population|Density|LigandAnnotID|ECMpAnnotID)",x=names(slDT),value=TRUE)
  
  #Remove Spot normalized values
  mepNames<-grep(pattern="(SpotNorm$)",x=mepNames,value=TRUE,invert=TRUE)
  
  mepKeep<-slDT[,mepNames,with=FALSE]
  mepDT<-mepKeep[,lapply(.SD,numericMedian),keyby="LigandAnnotID,ECMpAnnotID"]
  
  #Merge back in the replicate metadata
  mDT <- slDT[,list(Name,ID,ShortName,Well,CellLine,Ligand,Endpoint488,Endpoint555,Endpoint647,DAPI,ECMp),keyby="LigandAnnotID,ECMpAnnotID"]
  mepDT <- mDT[mepDT, mult="first"]
  
```

```{r, echo=FALSE, eval=TRUE}
  
write.table(mepDT, paste0(ss,"/Cell/Annotated Data/",unique(slDT$CellLine),"_",ss,"_","CellMepAnn.txt"), sep = "\t",row.names = FALSE, quote=FALSE)

```
